<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ‹ã‚³ã‚¿ãƒ³ Cloud</title>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
    :root {
        --primary: #5d75d6; --accent: #6ce5e8; --bg: #fcfdfd;
        --card: #ffffff; --text: #4a4a4a; --wrong: #ff6b6b; --correct: #4ecdc4;
    }
    body {
        font-family: "M PLUS Rounded 1c", sans-serif;
        background: var(--bg); margin: 0; color: var(--text);
        display: flex; flex-direction: column; height: 100vh;
        background-image: radial-gradient(#e0e7ff 1px, transparent 1px);
        background-size: 20px 20px; overflow: hidden;
    }
    header {
        background: var(--primary); color: white; padding: 10px 20px;
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 4px 10px rgba(93, 117, 214, 0.2); z-index: 10;
    }
    h1 { margin: 0; font-size: 1.2rem; font-weight: 800; }
    .status-badge {
        font-size: 0.8rem; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 10px;
    }
    .container {
        flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 1rem; position: relative; width: 100%; max-width: 800px; margin: 0 auto; box-sizing: border-box;
    }
    .screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg); display: none; flex-direction: column;
        align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; z-index: 20;
    }
    .screen.active { display: flex; }
    .card-box {
        background: white; padding: 2rem; border-radius: 25px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 4px solid #f0f4ff;
        width: 100%; max-width: 400px; text-align: center;
    }
    select {
        width: 100%; padding: 1rem; border: 2px solid var(--primary);
        border-radius: 15px; font-size: 1.1rem; font-weight: bold;
        color: var(--primary); background: #f0f4ff; margin-bottom: 1rem;
    }
    .big-btn {
        background: var(--primary); color: white; border: none;
        padding: 1rem 3rem; font-size: 1.5rem; border-radius: 50px;
        font-weight: 800; cursor: pointer; box-shadow: 0 6px 0 rgba(46, 61, 128, 0.3);
        transition: transform 0.1s; margin-top: 10px;
    }
    .big-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(46, 61, 128, 0.3); }
    .flashcard {
        background: white; width: 100%; max-width: 600px; height: 260px;
        border-radius: 25px; display: flex; flex-direction: column;
        align-items: center; justify-content: center; margin-bottom: 2rem;
        border: 4px solid #f0f4ff; border-bottom: 8px solid #e0e7ff; position: relative;
    }
    .word-text { font-size: 3rem; font-weight: 800; }
    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width: 100%; max-width: 600px; }
    .opt-btn {
        background: white; border: 3px solid #edeff4; border-radius: 15px;
        padding: 1.2rem; font-weight: bold; font-size: 1rem; cursor: pointer;
        transition: 0.2s;
    }
    #loading-msg { font-weight: bold; color: var(--primary); margin-top: 10px; }
    @media (max-width: 600px) {
        .options-grid { grid-template-columns: 1fr; }
        .word-text { font-size: 2.2rem; }
    }
</style>
</head>
<body>

<header>
    <h1>ãƒ‹ã‚³ã‚¿ãƒ³ Cloud</h1>
    <div class="status-badge" id="data-status">ğŸ“¡ Connecting...</div>
</header>

<div class="container">
    <div id="screen-load" class="screen active">
        <div class="card-box">
            <h2>æ•™æã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</h2>
            <p style="color:#939bb4;">å…ˆç”Ÿã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰<br>æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­</p>
            <div id="loading-msg">waiting...</div>
        </div>
    </div>

    <div id="screen-start" class="screen">
        <div class="card-box">
            <label style="display:block; text-align:left; color:#939bb4; font-weight:800; margin-bottom:5px;">Unit Select</label>
            <select id="unitSelect"></select>
            <label style="display:block; text-align:left; color:#939bb4; font-weight:800; margin-bottom:5px;">Mode</label>
            <select id="modeSelect">
                <option value="en-jp">ğŸ“ è‹± â†’ æ—¥ (4æŠ)</option>
                <option value="jp-en">ğŸ”„ æ—¥ â†’ è‹± (4æŠ)</option>
                <option value="flash">ğŸ“‡ ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</option>
            </select>
            <button class="big-btn" onclick="startGame()">START</button>
        </div>
        <div style="margin-top:20px; color:#939bb4; font-size:0.8rem;">
            â€» ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div style="width:100%; max-width:600px; display:flex; justify-content:space-between; margin-bottom:10px; font-weight:800; color:#939bb4;">
            <span onclick="location.reload()" style="cursor:pointer;">âŒ ä¸­æ–­</span>
            <span id="score-disp">0 / 0</span>
        </div>
        <div class="flashcard" id="card-area" onclick="handleCardClick()">
            <div id="q-text" class="word-text"></div>
            <div id="h-text" style="color:#939bb4; margin-top:10px; font-weight:bold;"></div>
            <span style="position:absolute; top:15px; right:15px; font-size:1.5rem; cursor:pointer;" onclick="speak(currentWord.en); event.stopPropagation();">ğŸ”Š</span>
        </div>
        <div id="options-area" class="options-grid"></div>
        <div id="flash-controls" style="display:none; gap:20px;">
            <button class="opt-btn" onclick="nextQuestion(-1)">â† Prev</button>
            <button class="opt-btn" onclick="nextQuestion(1)">Next â†’</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="card-box">
            <h2 style="color:var(--primary); font-size:2rem; margin:0;">Great Job!</h2>
            <p id="final-score" style="font-size:1.5rem; font-weight:800; margin:1rem 0;">Score: 100%</p>
            <button class="big-btn" onclick="location.reload()">ã‚‚ã†ä¸€åº¦</button>
        </div>
    </div>
</div>

<script>
    // å…ˆç”Ÿã®URLã‚’åŸ‹ã‚è¾¼ã¿æ¸ˆã¿ã§ã™ï¼
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQkjW85DByBOi5XpuXoGq1OrHytiO2tJNdariA_GDO6ETQCDSgFGsJuy427qxrjN6kKOElWMEdIg3XC/pub?output=csv";

    let allData = [], unitData = {}, playQueue = [], currentIndex = 0, score = 0, mode = "en-jp", currentWord = null;

    window.onload = function() {
        if(SHEET_CSV_URL === "") {
            document.getElementById('loading-msg').innerHTML = "âš ï¸ URLã‚¨ãƒ©ãƒ¼"; return;
        }
        Papa.parse(SHEET_CSV_URL, {
            download: true, header: true,
            complete: function(results) { processData(results.data); },
            error: function(err) { document.getElementById('loading-msg').innerText = "âš ï¸ èª­ã¿è¾¼ã¿å¤±æ•—: " + err; }
        });
    };

    function processData(data) {
        allData = data.filter(row => row.Unit && row.English);
        if(allData.length === 0) {
            document.getElementById('loading-msg').innerText = "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™"; return;
        }
        unitData = {};
        allData.forEach(row => {
            if(!unitData[row.Unit]) unitData[row.Unit] = [];
            unitData[row.Unit].push({ en: row.English, ja: row.Japanese });
        });
        const sel = document.getElementById('unitSelect');
        Object.keys(unitData).forEach(u => {
            const opt = document.createElement('option');
            opt.value = u; opt.textContent = u;
            sel.appendChild(opt);
        });
        document.getElementById('data-status').textContent = "âœ… Data Ready";
        showScreen('screen-start');
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function startGame() {
        const unit = document.getElementById('unitSelect').value;
        mode = document.getElementById('modeSelect').value;
        if(!unit) return;
        playQueue = [...unitData[unit]].sort(() => Math.random() - 0.5);
        currentIndex = 0; score = 0;
        showScreen('screen-game');
        const isFlash = (mode === 'flash');
        document.getElementById('options-area').style.display = isFlash ? 'none' : 'grid';
        document.getElementById('flash-controls').style.display = isFlash ? 'flex' : 'none';
        renderQuestion();
    }

    function renderQuestion() {
        if(currentIndex >= playQueue.length) {
            document.getElementById('final-score').innerText = `Score: ${score} / ${playQueue.length}`;
            showScreen('screen-result'); return;
        }
        currentWord = playQueue[currentIndex];
        document.getElementById('score-disp').textContent = `${currentIndex + 1} / ${playQueue.length}`;
        const qText = document.getElementById('q-text');
        const hText = document.getElementById('h-text');
        hText.textContent = "";
        if(mode === 'en-jp' || mode === 'flash') {
            qText.textContent = currentWord.en;
            if(mode === 'en-jp') speak(currentWord.en);
        } else {
            qText.textContent = currentWord.ja;
        }
        if(mode !== 'flash') generateOptions();
    }

    function generateOptions() {
        const correct = currentWord;
        const area = document.getElementById('options-area');
        area.innerHTML = "";
        let pool = allData.filter(w => w.English !== correct.English);
        let choices = [correct, ...pool.sort(() => Math.random()-0.5).slice(0, 3)].sort(() => Math.random() - 0.5);
        choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.textContent = (mode === 'en-jp') ? c.Japanese : c.English;
            btn.onclick = () => checkAnswer(c.English === correct.English, btn);
            area.appendChild(btn);
        });
    }

    function checkAnswer(isCorrect, btn) {
        if(isCorrect) {
            btn.style.background = "var(--correct)"; btn.style.color = "white"; score++;
            if(mode === 'jp-en') speak(currentWord.en);
            setTimeout(() => nextQuestion(1), 600);
        } else {
            btn.style.background = "var(--wrong)"; btn.style.color = "white";
            setTimeout(() => nextQuestion(1), 1000);
        }
    }

    function handleCardClick() {
        if(mode !== 'flash') return;
        const qText = document.getElementById('q-text');
        const hText = document.getElementById('h-text');
        if(qText.textContent === currentWord.en) {
            qText.textContent = currentWord.ja; hText.textContent = currentWord.en;
        } else {
            qText.textContent = currentWord.en; hText.textContent = ""; speak(currentWord.en);
        }
    }

    function nextQuestion(step) {
        currentIndex += step;
        if(currentIndex < 0) currentIndex = 0;
        renderQuestion();
    }

    function speak(text) {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        speechSynthesis.speak(u);
    }
</script>
</body>
</html>
