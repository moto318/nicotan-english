<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ‹ã‚³ã‚¿ãƒ³ Ultimate</title>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
    :root {
        --primary: #5d75d6; --accent: #6ce5e8; --bg: #fcfdfd;
        --card: #ffffff; --text: #4a4a4a; --wrong: #ff6b6b; --correct: #4ecdc4;
    }
    body {
        font-family: "M PLUS Rounded 1c", sans-serif;
        background: var(--bg); margin: 0; color: var(--text);
        display: flex; flex-direction: column; height: 100vh;
        background-image: radial-gradient(#e0e7ff 1px, transparent 1px);
        background-size: 20px 20px; overflow: hidden;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    header {
        background: var(--primary); color: white; padding: 10px 20px;
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 4px 10px rgba(93, 117, 214, 0.2); z-index: 10;
    }
    h1 { margin: 0; font-size: 1.2rem; font-weight: 800; }
    .status-badge { font-size: 0.8rem; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 10px; }

    /* ã‚³ãƒ³ãƒ†ãƒŠ & ç”»é¢é·ç§» */
    .container {
        flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 1rem; position: relative; width: 100%; max-width: 800px; margin: 0 auto; box-sizing: border-box;
    }
    .screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg); display: none; flex-direction: column;
        align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; z-index: 20;
        overflow-y: auto;
    }
    .screen.active { display: flex; }

    /* å…±é€šãƒ‘ãƒ¼ãƒ„ */
    .card-box {
        background: white; padding: 1.5rem; border-radius: 25px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 4px solid #f0f4ff;
        width: 100%; max-width: 450px; text-align: center;
    }
    select, input[type="text"] {
        width: 100%; padding: 0.8rem; border: 2px solid var(--primary);
        border-radius: 15px; font-size: 1rem; font-weight: bold;
        color: var(--primary); background: #f0f4ff; margin-bottom: 1rem; box-sizing: border-box;
    }
    .big-btn {
        background: var(--primary); color: white; border: none;
        padding: 1rem 3rem; font-size: 1.4rem; border-radius: 50px;
        font-weight: 800; cursor: pointer; box-shadow: 0 6px 0 rgba(46, 61, 128, 0.3);
        transition: transform 0.1s; margin-top: 10px;
    }
    .big-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(46, 61, 128, 0.3); }

    /* è¨­å®šã‚¨ãƒªã‚¢ */
    .settings-area {
        border: 2px dashed #dce2f2; border-radius: 15px; padding: 1rem;
        margin-bottom: 1rem; text-align: left; background: rgba(255,255,255,0.8);
    }
    .setting-row {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 10px; font-weight: 800; color: #7a82a0; font-size: 0.9rem;
    }
    /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
    .switch { position: relative; display: inline-block; width: 46px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #ccc; transition: .4s; border-radius: 34px;
    }
    .slider:before {
        position: absolute; content: ""; height: 18px; width: 18px;
        left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* ã‚²ãƒ¼ãƒ ç”»é¢ */
    .flashcard {
        background: white; width: 100%; max-width: 600px; height: 240px;
        border-radius: 25px; display: flex; flex-direction: column;
        align-items: center; justify-content: center; margin-bottom: 1.5rem;
        border: 4px solid #f0f4ff; border-bottom: 8px solid #e0e7ff; position: relative; cursor: pointer;
    }
    .word-text { font-size: 2.8rem; font-weight: 800; line-height: 1.2; text-align: center;}
    .sub-text { color: #939bb4; font-weight: 800; margin-top: 10px; font-size: 1rem; }
    .speaker-icon { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; z-index: 5; }
    
    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; width: 100%; max-width: 600px; }
    .opt-btn {
        background: white; border: 3px solid #edeff4; border-radius: 15px;
        padding: 1rem; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.1s;
    }
    .opt-btn:active { transform: scale(0.98); }

    /* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ */
    .typing-box { width: 100%; max-width: 500px; text-align: center; display: none; }
    #typing-input {
        font-size: 1.5rem; text-align: center; letter-spacing: 2px;
        border: 3px solid var(--primary); background: white;
    }
    #typing-feedback { height: 30px; font-weight: 800; margin-top: 5px; font-size: 1.2rem; }

    @media (max-width: 600px) {
        .options-grid { grid-template-columns: 1fr; }
        .word-text { font-size: 2rem; }
    }
</style>
</head>
<body>

<header>
    <h1>ãƒ‹ã‚³ã‚¿ãƒ³ Ultimate</h1>
    <div class="status-badge" id="data-status">Connecting...</div>
</header>

<div class="container">

    <div id="screen-load" class="screen active">
        <div class="card-box">
            <h2>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™</h2>
            <p style="color:#939bb4;">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨é€šä¿¡ä¸­...</p>
            <div id="loading-msg" style="color:var(--primary); font-weight:bold;">waiting...</div>
        </div>
    </div>

    <div id="screen-start" class="screen">
        <div class="card-box">
            <label style="display:block; text-align:left; color:#939bb4; font-weight:800; margin-bottom:5px;">Unit Select</label>
            <select id="unitSelect"></select>

            <label style="display:block; text-align:left; color:#939bb4; font-weight:800; margin-bottom:5px;">Mode</label>
            <select id="modeSelect">
                <option value="en-jp">ğŸ“ è‹± â†’ æ—¥ (4æŠ)</option>
                <option value="jp-en">ğŸ”„ æ—¥ â†’ è‹± (4æŠ)</option>
                <option value="flash">ğŸ“‡ ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</option>
                <option value="typing">âŒ¨ï¸ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°</option>
            </select>

            <div class="settings-area">
                <div class="setting-row">
                    <span>ğŸ”€ ã‚·ãƒ£ãƒƒãƒ•ãƒ«</span>
                    <label class="switch"><input type="checkbox" id="shuffleCheck" checked><span class="slider"></span></label>
                </div>
                <div class="setting-row">
                    <span>ğŸ”Š è‡ªå‹•èª­ã¿ä¸Šã’</span>
                    <label class="switch"><input type="checkbox" id="autoPlayCheck" checked><span class="slider"></span></label>
                </div>
                <div class="setting-row" style="flex-direction:column; align-items:stretch;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>ğŸ—£ï¸ é€Ÿåº¦</span><span id="rateVal">1.0</span>
                    </div>
                    <input type="range" id="rateSlider" min="0.5" max="1.5" step="0.1" value="1.0" oninput="document.getElementById('rateVal').innerText=this.value" style="width:100%; accent-color:var(--primary);">
                </div>
                <div class="setting-row">
                    <span>ğŸ™ï¸ éŸ³å£°</span>
                    <select id="voiceSelect" style="width:120px; margin:0; padding:5px; font-size:0.8rem;">
                        <option value="">Default</option>
                    </select>
                </div>
            </div>
            
            <button class="big-btn" onclick="startGame()">START</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div style="width:100%; max-width:600px; display:flex; justify-content:space-between; margin-bottom:10px; font-weight:800; color:#939bb4;">
            <span onclick="confirmQuit()" style="cursor:pointer; border:1px solid #ccc; padding:2px 8px; border-radius:10px;">âŒ ä¸­æ–­</span>
            <span id="score-disp">0 / 0</span>
        </div>

        <div class="flashcard" id="card-area" onclick="handleCardClick()">
            <div id="q-text" class="word-text"></div>
            <div id="h-text" class="sub-text"></div>
            <span class="speaker-icon" onclick="speakCurrent(); event.stopPropagation();">ğŸ”Š</span>
        </div>

        <div id="options-area" class="options-grid"></div>

        <div id="typing-area" class="typing-box">
            <input type="text" id="typing-input" placeholder="Type here..." autocomplete="off">
            <div id="typing-feedback"></div>
        </div>

        <div id="flash-controls" style="display:none; gap:20px; margin-top:10px;">
            <button class="opt-btn" onclick="nextQuestion(-1)">â† Prev</button>
            <button class="opt-btn" onclick="nextQuestion(1)">Next â†’</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="card-box">
            <h2 style="color:var(--primary); font-size:2rem; margin:0;">Great Job!</h2>
            <p id="final-score" style="font-size:1.5rem; font-weight:800; margin:1rem 0;">Score: 100%</p>
            <button class="big-btn" onclick="location.reload()">ã‚‚ã†ä¸€åº¦</button>
        </div>
    </div>

</div>

<script>
    // ==========================================
    // å…ˆç”Ÿã®URLã‚’ã‚»ãƒƒãƒˆæ¸ˆã¿ã§ã™ï¼
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQkjW85DByBOi5XpuXoGq1OrHytiO2tJNdariA_GDO6ETQCDSgFGsJuy427qxrjN6kKOElWMEdIg3XC/pub?output=csv";
    // ==========================================

    let allData = [], unitData = {}, playQueue = [];
    let currentIndex = 0, score = 0, mode = "en-jp", currentWord = null;
    let isAnswering = false;
    let availableVoices = [];

    // åˆæœŸåŒ–
    window.onload = function() {
        if(!SHEET_CSV_URL) {
            document.getElementById('loading-msg').innerText = "URLæœªè¨­å®š"; return;
        }
        initVoices();
        fetchData();
        
        // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç”¨ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼
        document.getElementById('typing-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') checkTyping();
        });
    };

    function fetchData() {
        Papa.parse(SHEET_CSV_URL, {
            download: true, header: true,
            complete: function(results) { processData(results.data); },
            error: function(err) { document.getElementById('loading-msg').innerText = "èª­è¾¼å¤±æ•—: " + err; }
        });
    }

    function processData(data) {
        allData = data.filter(row => row.Unit && row.English);
        if(allData.length === 0) {
            document.getElementById('loading-msg').innerText = "ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™"; return;
        }
        unitData = {};
        allData.forEach(row => {
            if(!unitData[row.Unit]) unitData[row.Unit] = [];
            unitData[row.Unit].push({ en: row.English, ja: row.Japanese });
        });
        const sel = document.getElementById('unitSelect');
        Object.keys(unitData).forEach(u => {
            const opt = document.createElement('option');
            opt.value = u; opt.textContent = u;
            sel.appendChild(opt);
        });
        document.getElementById('data-status').textContent = "âœ… Ready";
        showScreen('screen-start');
    }

    // éŸ³å£°ãƒªã‚¹ãƒˆå–å¾— (é ‘ä¸ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³)
    function initVoices() {
        const load = () => {
            availableVoices = speechSynthesis.getVoices();
            const sel = document.getElementById('voiceSelect');
            // ã™ã§ã«é¸æŠè‚¢ãŒã‚ã‚‹å ´åˆã¯ãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼ˆãƒãƒ©ã¤ãé˜²æ­¢ï¼‰
            if(sel.options.length > 1 && availableVoices.length > 0) return;
            
            sel.innerHTML = '<option value="">Default</option>';
            const enVoices = availableVoices.filter(v => v.lang.includes('en'));
            (enVoices.length ? enVoices : availableVoices).forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.name; opt.textContent = v.name.substr(0, 15);
                if(v.default) opt.selected = true;
                sel.appendChild(opt);
            });
        };
        speechSynthesis.onvoiceschanged = load;
        load();
        // ãƒ­ãƒ¼ãƒ‰ãŒé…ã„å ´åˆã®ãŸã‚ã®ä¿é™º
        setTimeout(load, 1000);
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function startGame() {
        const unit = document.getElementById('unitSelect').value;
        mode = document.getElementById('modeSelect').value;
        if(!unit) return;

        // ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼šéŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚¦ã‚§ã‚¤ã‚¯ã‚¢ãƒƒãƒ—
        if(speechSynthesis.paused) speechSynthesis.resume();

        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«è¨­å®š
        const doShuffle = document.getElementById('shuffleCheck').checked;
        playQueue = [...unitData[unit]];
        if(doShuffle) playQueue.sort(() => Math.random() - 0.5);

        currentIndex = 0; score = 0;
        showScreen('screen-game');
        
        // UIåˆ‡ã‚Šæ›¿ãˆ
        const isFlash = (mode === 'flash');
        const isTyping = (mode === 'typing');
        
        document.getElementById('options-area').style.display = (isFlash || isTyping) ? 'none' : 'grid';
        document.getElementById('typing-area').style.display = isTyping ? 'block' : 'none';
        document.getElementById('flash-controls').style.display = isFlash ? 'flex' : 'none';
        
        renderQuestion();
    }

    function renderQuestion() {
        if(currentIndex >= playQueue.length) {
            document.getElementById('final-score').innerText = `Score: ${score} / ${playQueue.length}`;
            showScreen('screen-result'); return;
        }
        isAnswering = true;
        currentWord = playQueue[currentIndex];
        document.getElementById('score-disp').textContent = `${currentIndex + 1} / ${playQueue.length}`;
        
        const qText = document.getElementById('q-text');
        const hText = document.getElementById('h-text');
        hText.textContent = "";

        // ãƒ¢ãƒ¼ãƒ‰åˆ¥è¡¨ç¤º
        if(mode === 'en-jp' || mode === 'flash') {
            qText.textContent = currentWord.en;
            if(mode === 'en-jp' && document.getElementById('autoPlayCheck').checked) {
                // å°‘ã—é…å»¶ã•ã›ã¦ç¢ºå®Ÿã«å†ç”Ÿ
                setTimeout(speakCurrent, 100);
            }
        } else {
            // jp-en ã¾ãŸã¯ typing
            qText.textContent = currentWord.ja;
        }

        // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã®ãƒªã‚»ãƒƒãƒˆ
        if(mode === 'typing') {
            const inp = document.getElementById('typing-input');
            inp.value = ""; inp.disabled = false; inp.focus();
            document.getElementById('typing-feedback').textContent = "";
        }

        if(mode === 'en-jp' || mode === 'jp-en') generateOptions();
    }

    function generateOptions() {
        const correct = currentWord;
        const area = document.getElementById('options-area');
        area.innerHTML = "";
        let pool = allData.filter(w => w.English !== correct.English);
        let choices = [correct, ...pool.sort(() => Math.random()-0.5).slice(0, 3)].sort(() => Math.random()-0.5);
        choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.textContent = (mode === 'en-jp') ? c.Japanese : c.English;
            btn.onclick = () => checkAnswer(c.English === correct.English, btn);
            area.appendChild(btn);
        });
    }

    function checkAnswer(isCorrect, btn) {
        if(!isAnswering) return;
        isAnswering = false;
        if(isCorrect) {
            btn.style.background = "var(--correct)"; btn.style.color = "white"; score++;
            if(mode === 'jp-en') speakCurrent();
            setTimeout(() => nextQuestion(1), 600);
        } else {
            btn.style.background = "var(--wrong)"; btn.style.color = "white";
            setTimeout(() => nextQuestion(1), 1200);
        }
    }

    function checkTyping() {
        if(!isAnswering) return;
        const inp = document.getElementById('typing-input');
        const userVal = inp.value.trim().toLowerCase();
        const correctVal = currentWord.en.toLowerCase();
        const fb = document.getElementById('typing-feedback');
        
        isAnswering = false;
        inp.disabled = true;

        if(userVal === correctVal) {
            fb.textContent = "Great! âœ¨"; fb.style.color = "var(--correct)";
            score++; speakCurrent();
            setTimeout(() => nextQuestion(1), 800);
        } else {
            fb.textContent = `æ­£è§£: ${currentWord.en}`; fb.style.color = "var(--wrong)";
            setTimeout(() => nextQuestion(1), 2000);
        }
    }

    function handleCardClick() {
        if(mode !== 'flash') return;
        const qText = document.getElementById('q-text');
        const hText = document.getElementById('h-text');
        if(qText.textContent === currentWord.en) {
            qText.textContent = currentWord.ja; hText.textContent = currentWord.en;
        } else {
            qText.textContent = currentWord.en; hText.textContent = ""; speakCurrent();
        }
    }

    function nextQuestion(step) {
        currentIndex += step;
        if(currentIndex < 0) currentIndex = 0;
        renderQuestion();
    }

    // é ‘ä¸ˆã«ãªã£ãŸèª­ã¿ä¸Šã’é–¢æ•°
    function speakCurrent() {
        // é‡è¤‡å†ç”Ÿé˜²æ­¢
        speechSynthesis.cancel();

        const u = new SpeechSynthesisUtterance(currentWord.en);
        u.lang = 'en-US';
        
        // é€Ÿåº¦è¨­å®šï¼ˆæ•°å€¤ã¨ã—ã¦ç¢ºå®Ÿã«å–å¾—ï¼‰
        const rateVal = parseFloat(document.getElementById('rateSlider').value);
        u.rate = isNaN(rateVal) ? 1.0 : rateVal;

        // éŸ³å£°è¨­å®šï¼ˆé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿é©ç”¨ï¼‰
        const vName = document.getElementById('voiceSelect').value;
        if(vName && availableVoices.length > 0) {
            const v = availableVoices.find(x => x.name === vName);
            if(v) u.voice = v;
        }

        speechSynthesis.speak(u);
    }
    
    function confirmQuit() {
        if(confirm("ä¸­æ–­ã—ã¦æœ€åˆã®ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) location.reload();
    }
</script>
</body>
</html>
